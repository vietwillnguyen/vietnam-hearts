<!DOCTYPE html>
<html>
<head>
    <title>Authentication Test - Vietnam Hearts</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        button:hover { background: #0056b3; }
        .token-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
        }
        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîê Vietnam Hearts Authentication Test</h1>
    
    <div class="container">
        <h2>üìã Current Status</h2>
        <div id="status">Checking authentication status...</div>
        <div id="user-info"></div>
    </div>
    
    <div class="container">
        <h2>üîë Authentication</h2>
        <button onclick="initiateSignIn()">Sign In with Google</button>
        <button onclick="signOut()">Sign Out</button>
        <button onclick="refreshSession()">Refresh Session</button>
        <button onclick="checkTokens()">Check Stored Tokens</button>
    </div>
    
    <div class="container">
        <h2>üß™ Test Endpoints</h2>
        <button onclick="testHealth()">Test Health Endpoint</button>
        <button onclick="testDashboard()">Test Dashboard (Admin)</button>
        <button onclick="testVolunteers()">Test Volunteers (Admin)</button>
        <button onclick="testPublicHealth()">Test Public Health</button>
    </div>
    
    <div class="container">
        <h2>üìù Token Information</h2>
        <div id="token-info">
            <p><strong>Access Token:</strong></p>
            <div id="access-token" class="token-display">Not set</div>
            <p><strong>Refresh Token:</strong></p>
            <div id="refresh-token" class="token-display">Not set</div>
            <p><strong>User Email:</strong></p>
            <div id="user-email" class="token-display">Not set</div>
        </div>
    </div>
    
    <div class="container">
        <h2>üìä Request Log</h2>
        <div id="request-log" class="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        
        // Logging function
        function log(message, type = 'info') {
            const logDiv = document.getElementById('request-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span class="${type}">[${timestamp}] ${message}</span>`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // Check authentication status on page load
        window.onload = function() {
            checkAuthentication();
            updateTokenDisplay();
        };
        
        // Check if user is authenticated
        async function checkAuthentication() {
            const accessToken = localStorage.getItem('access_token');
            const statusDiv = document.getElementById('status');
            const userInfoDiv = document.getElementById('user-info');
            
            if (!accessToken) {
                statusDiv.innerHTML = '<span class="error">‚ùå Not authenticated</span>';
                userInfoDiv.innerHTML = '<p>Please sign in to access admin features.</p>';
                return false;
            }
            
            try {
                log('Checking authentication status...');
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    statusDiv.innerHTML = '<span class="success">‚úÖ Authenticated</span>';
                    userInfoDiv.innerHTML = `
                        <p><strong>Email:</strong> ${userData.email || 'N/A'}</p>
                        <p><strong>Name:</strong> ${userData.name || 'N/A'}</p>
                        <p><strong>Role:</strong> ${userData.role || 'User'}</p>
                    `;
                    log('Authentication check successful', 'success');
                    return true;
                } else {
                    statusDiv.innerHTML = '<span class="error">‚ùå Authentication failed</span>';
                    userInfoDiv.innerHTML = '<p>Token appears to be invalid. Please sign in again.</p>';
                    log(`Authentication check failed: ${response.status}`, 'error');
                    return false;
                }
            } catch (error) {
                statusDiv.innerHTML = '<span class="error">‚ùå Authentication check error</span>';
                userInfoDiv.innerHTML = `<p>Error: ${error.message}</p>`;
                log(`Authentication check error: ${error.message}`, 'error');
                return false;
            }
        }
        
        // Update token display
        function updateTokenDisplay() {
            const accessToken = localStorage.getItem('access_token') || 'Not set';
            const refreshToken = localStorage.getItem('refresh_token') || 'Not set';
            const userEmail = localStorage.getItem('user_email') || 'Not set';
            
            document.getElementById('access-token').textContent = accessToken;
            document.getElementById('refresh-token').textContent = refreshToken;
            document.getElementById('user-email').textContent = userEmail;
        }
        
        // Initiate Google sign-in
        async function initiateSignIn() {
            try {
                log('Initiating Google sign-in...');
                const response = await fetch(`${API_BASE}/auth/signin/google`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        redirect_to: `${API_BASE}/auth/callback`
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log('Sign-in initiated successfully', 'success');
                    log(`Auth URL: ${result.auth_url}`, 'info');
                    
                    // Open the auth URL in a new window
                    window.open(result.auth_url, '_blank', 'width=500,height=600');
                    
                    // Poll for authentication completion
                    pollForAuthentication();
                } else {
                    const error = await response.text();
                    log(`Sign-in failed: ${response.status} - ${error}`, 'error');
                }
            } catch (error) {
                log(`Sign-in error: ${error.message}`, 'error');
            }
        }
        
        // Poll for authentication completion
        function pollForAuthentication() {
            const pollInterval = setInterval(async () => {
                const accessToken = localStorage.getItem('access_token');
                if (accessToken) {
                    log('Authentication detected!', 'success');
                    clearInterval(pollInterval);
                    await checkAuthentication();
                    updateTokenDisplay();
                }
            }, 1000);
            
            // Stop polling after 5 minutes
            setTimeout(() => {
                clearInterval(pollInterval);
                log('Authentication polling stopped', 'warning');
            }, 300000);
        }
        
        // Sign out
        async function signOut() {
            try {
                const accessToken = localStorage.getItem('access_token');
                if (accessToken) {
                    log('Signing out...');
                    const response = await fetch(`${API_BASE}/auth/signout`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });
                    
                    if (response.ok) {
                        log('Sign-out successful', 'success');
                    } else {
                        log(`Sign-out failed: ${response.status}`, 'warning');
                    }
                }
                
                // Clear local storage
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('user_email');
                localStorage.removeItem('user_name');
                
                log('Local storage cleared', 'info');
                await checkAuthentication();
                updateTokenDisplay();
                
            } catch (error) {
                log(`Sign-out error: ${error.message}`, 'error');
            }
        }
        
        // Refresh session
        async function refreshSession() {
            const refreshToken = localStorage.getItem('refresh_token');
            if (!refreshToken) {
                log('No refresh token available', 'error');
                return;
            }
            
            try {
                log('Refreshing session...');
                const response = await fetch(`${API_BASE}/auth/refresh`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        refresh_token: refreshToken
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log('Session refreshed successfully', 'success');
                    
                    // Update tokens
                    if (result.access_token) {
                        localStorage.setItem('access_token', result.access_token);
                    }
                    if (result.refresh_token) {
                        localStorage.setItem('refresh_token', result.refresh_token);
                    }
                    
                    updateTokenDisplay();
                    await checkAuthentication();
                } else {
                    const error = await response.text();
                    log(`Session refresh failed: ${response.status} - ${error}`, 'error');
                }
            } catch (error) {
                log(`Session refresh error: ${error.message}`, 'error');
            }
        }
        
        // Check stored tokens
        function checkTokens() {
            log('Checking stored tokens...', 'info');
            updateTokenDisplay();
            
            const accessToken = localStorage.getItem('access_token');
            const refreshToken = localStorage.getItem('refresh_token');
            
            if (accessToken) {
                log(`Access token found: ${accessToken.substring(0, 20)}...`, 'success');
            } else {
                log('No access token found', 'error');
            }
            
            if (refreshToken) {
                log(`Refresh token found: ${refreshToken.substring(0, 20)}...`, 'success');
            } else {
                log('No refresh token found', 'error');
            }
        }
        
        // Test endpoints
        async function testHealth() {
            await testEndpoint('/health', 'Health');
        }
        
        async function testDashboard() {
            await testEndpoint('/admin/dashboard', 'Dashboard (Admin)');
        }
        
        async function testVolunteers() {
            await testEndpoint('/admin/volunteers', 'Volunteers (Admin)');
        }
        
        async function testPublicHealth() {
            await testEndpoint('/public/health', 'Public Health');
        }
        
        async function testEndpoint(endpoint, name) {
            try {
                log(`Testing ${name} endpoint...`);
                const accessToken = localStorage.getItem('access_token');
                const headers = {};
                
                if (accessToken) {
                    headers['Authorization'] = `Bearer ${accessToken}`;
                }
                
                const response = await fetch(`${API_BASE}${endpoint}`, { headers });
                const status = response.status;
                
                if (response.ok) {
                    log(`${name}: ‚úÖ ${status}`, 'success');
                } else if (status === 401) {
                    log(`${name}: ‚ùå ${status} - Unauthorized`, 'error');
                } else if (status === 403) {
                    log(`${name}: ‚ùå ${status} - Forbidden`, 'error');
                } else {
                    log(`${name}: ‚ö†Ô∏è ${status}`, 'warning');
                }
                
                // Try to get response text for debugging
                try {
                    const responseText = await response.text();
                    if (responseText) {
                        log(`Response: ${responseText.substring(0, 200)}...`, 'info');
                    }
                } catch (e) {
                    // Ignore errors reading response
                }
                
            } catch (error) {
                log(`${name}: ‚ùå Error - ${error.message}`, 'error');
            }
        }
        
        // Clear log
        function clearLog() {
            document.getElementById('request-log').innerHTML = '';
        }
    </script>
</body>
</html>
