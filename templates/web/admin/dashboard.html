<!DOCTYPE html>
<html>
<head>
    <title>Vietnam Hearts Admin Dashboard</title>
    
    <!-- Favicon using the Vietnam Hearts logo -->
    <link rel="icon" type="image/png" href="/static/vietnam-hearts-logo.ico">
    <link rel="shortcut icon" type="image/png" href="/static/vietnam-hearts-logo.ico">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .table-container {
            margin: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .nav-tabs {
            margin-bottom: 20px;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
        }
        .status-sent {
            background-color: #28a745;
            color: white;
        }
        .status-pending {
            background-color: #ffc107;
            color: black;
        }
        .status-failed {
            background-color: #dc3545;
            color: white;
        }
        .table {
            font-size: 0.9em;
        }
        .table th, .table td {
            padding: 8px 4px;
            vertical-align: middle;
        }
        .btn-group .btn {
            font-size: 0.8em;
            padding: 4px 8px;
            margin: 1px;
        }
        .settings-form {
            max-width: 800px;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .form-text {
            font-size: 0.875em;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        .dry-run-setting {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            margin-bottom: 1.5rem;
        }
        .dry-run-setting .form-label {
            color: #856404;
        }
        .badge {
            font-size: 0.75em;
            margin-left: 0.5rem;
        }
        .form-control.is-valid {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }
        .form-control.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
        .bot-test-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .bot-response {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-danger { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center my-4">
            <div>
                <h1>Vietnam Hearts Admin Dashboard</h1>
                <small class="text-muted">v{{ version }}</small>
            </div>
            <div>
                <span id="userInfo" class="me-3" style="display: none;">
                    <i class="fas fa-user"></i> <span id="userEmail"></span>
                </span>
                <button class="btn btn-outline-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </button>
            </div>
        </div>
        
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="volunteers-tab" data-bs-toggle="tab" href="#volunteers" role="tab">
                    Volunteers
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="emails-tab" data-bs-toggle="tab" href="#emails" role="tab">
                    Email Logs
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="admins-tab" data-bs-toggle="tab" href="#admins" role="tab">
                    Admin Management
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="settings-tab" data-bs-toggle="tab" href="#settings" role="tab">
                    Settings
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="schedule-tab" data-bs-toggle="tab" href="#schedule" role="tab">
                    Schedule Management
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="bot-tab" data-bs-toggle="tab" href="#bot" role="tab">
                    Bot Management
                </a>
            </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
            <!-- Volunteers Tab -->
            <div class="tab-pane fade show active" id="volunteers" role="tabpanel">
                <div class="table-container">
                    <h2>Volunteers ({{ total_volunteers }})</h2>
                    
                    <!-- Global Action Buttons -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">üìß Weekly Reminders</h5>
                                    <p class="card-text">Send weekly reminders to all subscribed volunteers</p>
                                    <button class="btn btn-primary global-action-btn" 
                                            data-action="send-all-weekly-reminders">
                                        <i class="fas fa-envelope"></i> Send All Weekly Reminders
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">üì¢ Announcement Recipients</h5>
                                    <p class="card-text">Get list of volunteers subscribed to announcements</p>
                                    <button class="btn btn-info global-action-btn" 
                                            data-action="get-announcement-recipients">
                                        <i class="fas fa-users"></i> Get Announcement Recipients
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">üîÑ Sync Actions</h5>
                                    <p class="card-text">Sync volunteers from Google Sheets</p>
                                    <button class="btn btn-success global-action-btn" 
                                            data-action="sync-volunteers">
                                        <i class="fas fa-sync"></i> Sync Volunteers from Sheets
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Weekly Reminders</th>
                                <th>All Emails</th>
                                <th>Confirmation Sent</th>
                                <th>Last Confirmation</th>
                                <th>Positions</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for volunteer in volunteers %}
                            <tr>
                                <td>{{ volunteer.id }}</td>
                                <td>{{ volunteer.name }}</td>
                                <td>{{ volunteer.email }}</td>
                                <td>
                                    {% if volunteer.is_active %}
                                    <span class="status-badge status-sent">Active</span>
                                    {% else %}
                                    <span class="status-badge status-failed">Inactive</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if volunteer.weekly_reminders_subscribed %}
                                    <span class="status-badge status-sent">Subscribed</span>
                                    {% else %}
                                    <span class="status-badge status-failed">Unsubscribed</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if volunteer.all_emails_subscribed %}
                                    <span class="status-badge status-sent">Subscribed</span>
                                    {% else %}
                                    <span class="status-badge status-failed">Unsubscribed</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if volunteer.confirmation_sent %}
                                    <span class="status-badge status-sent">Yes</span>
                                    {% else %}
                                    <span class="status-badge status-pending">No</span>
                                    {% endif %}
                                </td>
                                <td>{{ volunteer.last_confirmation_date or 'Never' }}</td>
                                <td>{{ volunteer.positions|default([])|join(', ') }}</td>
                                <td>{{ volunteer.created_at }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        {% if not volunteer.confirmation_sent %}
                                        <button class="btn btn-sm btn-success action-btn" 
                                                data-action="send-confirmation"
                                                data-volunteer-id="{{ volunteer.id }}"
                                                data-email="{{ volunteer.email }}">
                                            Send Confirmation
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-warning action-btn" 
                                                data-action="reset-confirmation"
                                                data-volunteer-id="{{ volunteer.id }}"
                                                data-email="{{ volunteer.email }}">
                                            Reset Confirmation Status
                                        </button>
                                        <button class="btn btn-sm btn-primary action-btn" 
                                                data-action="resend-confirmation"
                                                data-volunteer-id="{{ volunteer.id }}"
                                                data-email="{{ volunteer.email }}">
                                            Resend Confirmation
                                        </button>
                                        {% endif %}
                                        
                                        {% if volunteer.is_active %}
                                        <button class="btn btn-sm btn-danger action-btn" 
                                                data-action="deactivate"
                                                data-volunteer-id="{{ volunteer.id }}"
                                                data-email="{{ volunteer.email }}">
                                            Deactivate
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-success action-btn" 
                                                data-action="reactivate"
                                                data-volunteer-id="{{ volunteer.id }}"
                                                data-email="{{ volunteer.email }}">
                                            Reactivate
                                        </button>
                                        {% endif %}

                                        <!-- Weekly Reminder Button -->
                                        {% if volunteer.weekly_reminders_subscribed %}
                                        <button class="btn btn-sm btn-info action-btn" 
                                                data-action="send-weekly-reminder"
                                                data-volunteer-id="{{ volunteer.id }}"
                                                data-email="{{ volunteer.email }}">
                                            Send Weekly Reminder
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-secondary action-btn" 
                                                data-action="send-weekly-reminder"
                                                data-volunteer-id="{{ volunteer.id }}"
                                                data-email="{{ volunteer.email }}"
                                                disabled
                                                title="Volunteer is not subscribed to weekly reminders">
                                            Send Weekly Reminder
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Email Logs Tab -->
            <div class="tab-pane fade" id="emails" role="tabpanel">
                <div class="table-container">
                    <h2>Email Logs ({{ total_emails }})</h2>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Volunteer</th>
                                <th>Email</th>
                                <th>Type</th>
                                <th>Subject</th>
                                <th>Status</th>
                                <th>Sent At</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for email in emails %}
                            <tr>
                                <td>{{ email.id }}</td>
                                <td>{{ email.volunteer_name }}</td>
                                <td>{{ email.recipient_email }}</td>
                                <td>{{ email.email_type }}</td>
                                <td>{{ email.subject }}</td>
                                <td>
                                    <span class="status-badge status-{{ email.status }}">
                                        {{ email.status }}
                                    </span>
                                </td>
                                <td>{{ email.sent_at }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admin Management Tab -->
            <div class="tab-pane fade" id="admins" role="tabpanel">
                <div class="table-container">
                    <h2>Admin Management</h2>
                    <p class="text-muted">Manage admin users for Vietnam Hearts</p>
                    
                    <!-- Current User Info -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-user-shield"></i> Current User</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Email:</strong> <span id="currentUserEmail">Loading...</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Role:</strong> <span id="currentUserRole">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add New Admin Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-plus-circle"></i> Add New Admin</h5>
                        </div>
                        <div class="card-body">
                            <form id="add-admin-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="newAdminEmail" class="form-label">Email Address</label>
                                            <input type="email" class="form-control" id="newAdminEmail" 
                                                   placeholder="admin@vietnamhearts.org" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="newAdminRole" class="form-label">Role</label>
                                            <select class="form-control" id="newAdminRole" required>
                                                <option value="admin">Admin</option>
                                                <option value="super_admin">Super Admin</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="submit" class="btn btn-primary w-100">
                                                <i class="fas fa-plus"></i> Add Admin
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Current Admin Users -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-users-cog"></i> Current Admin Users</h5>
                            <span class="badge bg-primary" id="adminCount">Loading...</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="admins-table">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Last Login</th>
                                            <th>Added</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admins-table-body">
                                        <tr>
                                            <td colspan="6" class="text-center">Loading admins...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings" role="tabpanel">
                <div class="table-container">
                    <h2>Configuration Settings</h2>
                    
                    <!-- Dry Run Settings Section -->
                    <div class="alert alert-warning mb-4">
                        <h4>‚ö†Ô∏è Dry Run Settings</h4>
                        <p class="mb-0">These settings control whether the system operates in dry run mode for testing purposes.</p>
                    </div>
                    
                    <form id="settings-form" class="settings-form">
                        {% for setting in settings %}
                        <div class="form-group {% if setting.key in ['DRY_RUN', 'DRY_RUN_EMAIL_RECIPIENT'] %}dry-run-setting{% endif %}">
                            <label for="{{ setting.key }}" class="form-label">
                                {{ setting.key }}
                                {% if setting.key == 'DRY_RUN' %}
                                <span class="badge bg-warning text-dark">DRY RUN</span>
                                {% elif setting.key == 'DRY_RUN_EMAIL_RECIPIENT' %}
                                <span class="badge bg-warning text-dark">DRY RUN</span>
                                {% endif %}
                            </label>
                            
                            {% if setting.key == 'DRY_RUN' %}
                            <select class="form-control" id="{{ setting.key }}" name="{{ setting.key }}">
                                <option value="true" {% if setting.value == 'true' %}selected{% endif %}>True (Dry Run Mode)</option>
                                <option value="false" {% if setting.value == 'false' %}selected{% endif %}>False (Production Mode)</option>
                            </select>
                            {% elif setting.key == 'WEEKLY_REMINDERS_ENABLED' %}
                            <select class="form-control" id="{{ setting.key }}" name="{{ setting.key }}">
                                <option value="true" {% if setting.value == 'true' %}selected{% endif %}>True (Weekly Reminders Enabled)</option>
                                <option value="false" {% if setting.value == 'false' %}selected{% endif %}>False (Weekly Reminders Disabled)</option>
                            </select>
                            {% else %}
                            <input type="text" 
                                   class="form-control" 
                                   id="{{ setting.key }}" 
                                   name="{{ setting.key }}" 
                                   value="{{ setting.value }}"
                                   placeholder="{% if setting.key == 'SCHEDULE_SIGNUP_LINK' %}https://docs.google.com/spreadsheets/d/YOUR_SCHEDULE_SIGNUP_LINK/edit{% elif setting.key == 'NEW_SIGNUPS_RESPONSES_LINK' %}https://docs.google.com/spreadsheets/d/YOUR_SIGNUPS_SHEET_ID/edit{% else %}Enter value for {{ setting.key }}{% endif %}">
                            {% endif %}
                            
                            {% if setting.description %}
                            <div class="form-text">{{ setting.description }}</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                        
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">Save All Settings</button>
                            <button type="button" class="btn btn-secondary ms-2" onclick="resetToDefaults()">Reset to Defaults</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Schedule Management Tab -->
            <div class="tab-pane fade" id="schedule" role="tabpanel">
                <div class="table-container">
                    <h2>Schedule Management</h2>
                    
                    <!-- Schedule Status Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Current Schedule Status</h5>
                        </div>
                        <div class="card-body">
                            <div id="schedule-status-content">
                                <div class="text-center">
                                    <i class="fas fa-spinner fa-spin"></i> Loading schedule status...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Schedule Actions Section -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-cogs"></i> Schedule Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title">üîÑ Rotate Schedule</h6>
                                            <p class="card-text">Rotate schedule sheets to show the next week(s). This will hide old sheets and show new ones.</p>
                                            
                                            <div class="form-group mb-3">
                                                <label for="displayWeeks" class="form-label">Number of weeks to display:</label>
                                                <select class="form-control" id="displayWeeks">
                                                    <option value="">Use default setting</option>
                                                    <option value="1">1 week</option>
                                                    <option value="2">2 weeks</option>
                                                    <option value="3">3 weeks</option>
                                                    <option value="4">4 weeks (default)</option>
                                                    <option value="5">5 weeks</option>
                                                    <option value="6">6 weeks</option>
                                                    <option value="8">8 weeks</option>
                                                    <option value="10">10 weeks</option>
                                                    <option value="12">12 weeks</option>
                                                </select>
                                                <div class="form-text">Leave empty to use the default setting from the Settings tab</div>
                                            </div>
                                            
                                            <button class="btn btn-primary" onclick="rotateSchedule()">
                                                <i class="fas fa-sync"></i> Rotate Schedule
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title">üìä Schedule Statistics</h6>
                                            <p class="card-text">View detailed information about the current schedule setup.</p>
                                            
                                            <div id="schedule-stats">
                                                <div class="text-center">
                                                    <i class="fas fa-spinner fa-spin"></i> Loading statistics...
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bot Management Tab -->
            <div class="tab-pane fade" id="bot" role="tabpanel">
                <div class="table-container">
                    <h2>Bot Management</h2>
                    <p class="text-muted">Manage documents and knowledge base for the bot.</p>
                    
                    <!-- Sync Documents Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-sync-alt"></i> Sync Documents</h5>
                        </div>
                        <div class="card-body">
                            <p>Sync documents from your Google Drive to the bot's knowledge base. This will update the bot's ability to understand and respond to new documents.</p>
                            
                            <!-- Folder Selection -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="syncFolderId" class="form-label">
                                        <i class="fas fa-folder"></i> Google Drive Folder ID
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="syncFolderId" 
                                           placeholder="e.g., 1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms"
                                           title="Leave empty to sync from root directory, or enter a specific folder ID from Google Drive URL">
                                    <div class="form-text">
                                        <small>
                                            <i class="fas fa-info-circle"></i> 
                                            <strong>How to find folder ID:</strong><br>
                                            ‚Ä¢ Open the folder in Google Drive<br>
                                            ‚Ä¢ Copy the ID from the URL: <code>https://drive.google.com/drive/folders/FOLDER_ID_HERE</code><br>
                                            ‚Ä¢ Leave empty to sync from root directory
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">&nbsp;</label>
                                    <div>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="testFolderAccess()">
                                            <i class="fas fa-search"></i> Test Folder Access
                                        </button>
                                        <button class="btn btn-outline-info btn-sm ms-2" onclick="clearFolderSelection()">
                                            <i class="fas fa-times"></i> Clear
                                        </button>
                                    </div>
                                    <div id="folderTestResult" class="mt-2" style="display: none;"></div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info">
                                <small>
                                    <i class="fas fa-info-circle"></i> <strong>Batch Sync Process:</strong><br>
                                    1. Lists all available Google Docs from the selected folder<br>
                                    2. Syncs each document individually to the knowledge base<br>
                                    3. Creates embeddings for AI-powered responses<br>
                                    4. Shows detailed progress and results
                                </small>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <button class="btn btn-info" onclick="syncDocuments()">
                                        <i class="fas fa-cloud-upload-alt"></i> Sync Documents from Folder
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-outline-primary" onclick="listDocumentsInFolder()">
                                        <i class="fas fa-list"></i> Preview Documents
                                    </button>
                                </div>
                            </div>
                            
                            <div id="syncProgress" class="mt-3" style="display: none;">
                                <div class="progress">
                                    <div id="syncProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted" id="syncProgressText">Preparing...</small>
                            </div>
                        </div>
                    </div>

                    <!-- Check Knowledge Status Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle"></i> Check Knowledge Status</h5>
                        </div>
                        <div class="card-body">
                            <p>View the current status of the bot's knowledge base, including the number of documents and their last update.</p>
                            <button class="btn btn-primary" onclick="checkKnowledgeStatus()">
                                <i class="fas fa-database"></i> Check Knowledge Status
                            </button>
                        </div>
                    </div>

                                         <!-- List Available Documents Section -->
                     <div class="card mb-4">
                         <div class="card-header">
                             <h5 class="mb-0"><i class="fas fa-list"></i> List Available Documents</h5>
                         </div>
                         <div class="card-body">
                             <p>View a list of all documents currently available in the bot's knowledge base.</p>
                             <button class="btn btn-success" onclick="listAvailableDocuments()">
                                 <i class="fas fa-file-alt"></i> List Documents
                             </button>
                         </div>
                     </div>

                     <!-- Test Bot Section -->
                     <div class="card">
                         <div class="card-header">
                             <h5 class="mb-0"><i class="fas fa-robot"></i> Test Bot</h5>
                         </div>
                         <div class="card-body">
                             <p>Test the bot's responses with sample questions to verify knowledge base integration.</p>
                             
                             <!-- Sample Questions -->
                             <div class="mb-3">
                                 <small class="text-muted">Sample questions to test:</small>
                                 <div class="mt-2">
                                     <button type="button" class="btn btn-outline-secondary btn-sm me-2 mb-1" 
                                             onclick="setTestQuestion('What are the volunteer requirements?')">
                                         Volunteer Requirements
                                     </button>
                                     <button type="button" class="btn btn-outline-secondary btn-sm me-2 mb-1" 
                                             onclick="setTestQuestion('How do I sign up for classes?')">
                                         Class Signup
                                     </button>
                                     <button type="button" class="btn btn-outline-secondary btn-sm me-2 mb-1" 
                                             onclick="setTestQuestion('What is the schedule for this week?')">
                                         Weekly Schedule
                                     </button>
                                     <button type="button" class="btn btn-outline-secondary btn-sm me-2 mb-1" 
                                             onclick="setTestQuestion('Where are the classes held?')">
                                         Class Location
                                     </button>
                                 </div>
                             </div>
                             
                             <div class="row">
                                 <div class="col-md-8">
                                     <input type="text" id="testQuestion" class="form-control" 
                                            placeholder="Enter a test question (e.g., 'What are the volunteer requirements?')" />
                                 </div>
                                 <div class="col-md-4">
                                     <button class="btn btn-warning w-100" onclick="testBot()">
                                         <i class="fas fa-play"></i> Test Bot
                                     </button>
                                 </div>
                             </div>
                             <div id="testResult" class="mt-3" style="display: none;">
                                 <div class="bot-response">
                                     <h6><i class="fas fa-robot"></i> Bot Response:</h6>
                                     <div id="botResponse" class="mb-3"></div>
                                     <hr>
                                     <div class="row">
                                         <div class="col-md-4">
                                             <small>
                                                 <strong><i class="fas fa-chart-line"></i> Confidence:</strong><br>
                                                 <span id="botConfidence" class="badge bg-info"></span>
                                             </small>
                                         </div>
                                         <div class="col-md-4">
                                             <small>
                                                 <strong><i class="fas fa-file-alt"></i> Sources:</strong><br>
                                                 <span id="botSources" class="text-muted"></span>
                                             </small>
                                         </div>
                                         <div class="col-md-4">
                                             <small>
                                                 <strong><i class="fas fa-database"></i> Context Used:</strong><br>
                                                 <span id="botContext" class="badge bg-secondary"></span>
                                             </small>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>

                     <!-- Knowledge Base Debug Section -->
                     <div class="card mt-4">
                         <div class="card-header">
                             <h5 class="mb-0"><i class="fas fa-bug"></i> Knowledge Base Debug</h5>
                         </div>
                         <div class="card-body">
                             <p>Debug and inspect the knowledge base to understand what content is stored and how searches work.</p>
                             
                             <div class="row">
                                 <div class="col-md-4">
                                     <button class="btn btn-outline-info" onclick="inspectKnowledgeBaseChunks()">
                                         <i class="fas fa-database"></i> Inspect Stored Chunks
                                     </button>
                                 </div>
                                 <div class="col-md-4">
                                     <button class="btn btn-outline-warning" onclick="testKnowledgeBaseSearch()">
                                         <i class="fas fa-search"></i> Test Search
                                     </button>
                                 </div>
                                 <div class="col-md-4">
                                     <button class="btn btn-outline-secondary" onclick="clearDebugResults()">
                                         <i class="fas fa-times"></i> Clear Results
                                     </button>
                                 </div>
                             </div>
                             
                             <div id="debugResults" class="mt-3" style="display: none;">
                                 <div class="alert alert-info">
                                     <h6><i class="fas fa-info-circle"></i> Debug Results:</h6>
                                     <div id="debugContent"></div>
                                 </div>
                             </div>
                         </div>
                     </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize dashboard on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Check for auth error in localStorage (from auth callback)
            const authError = localStorage.getItem('auth_error');
            if (authError) {
                alert(`Access Error: ${authError}`);
                localStorage.removeItem('auth_error');
                window.location.href = '/';
                return;
            }
            
            // Check authentication first
            await checkAuthentication();
            
            // Add event listeners for action buttons
            document.querySelectorAll('.action-btn').forEach(button => {
                button.addEventListener('click', handleAction);
            });
            
            // Add event listeners for global action buttons
            document.querySelectorAll('.global-action-btn').forEach(button => {
                button.addEventListener('click', handleGlobalAction);
            });
            
            // Add event listener for admin form
            document.getElementById('add-admin-form').addEventListener('submit', handleAddAdmin);
            
            // Load admin data when admin tab is shown
            document.getElementById('admins-tab').addEventListener('shown.bs.tab', loadAdminData);
            
            // Load schedule data when schedule tab is shown
            document.getElementById('schedule-tab').addEventListener('shown.bs.tab', loadScheduleData);
            
            // Load bot data when bot tab is shown
            document.getElementById('bot-tab').addEventListener('shown.bs.tab', loadBotData);
            
            // Add event listener for folder ID input to save changes
            document.getElementById('syncFolderId').addEventListener('input', saveFolderId);
        });
        
        async function checkAuthentication() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/';
                return;
            }
            
            try {
                const response = await fetch('/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.status === 403) {
                    // Admin access denied
                    const errorMessage = 'You do not have admin access to this system.';
                    localStorage.setItem('auth_error', errorMessage);
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    window.location.href = '/';
                    return;
                } else if (!response.ok) {
                    // Token is invalid, redirect to home page
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    window.location.href = '/';
                    return;
                }
                
                const userData = await response.json();
                console.log('Authenticated as:', userData.user.email);
                
                // Display user information
                const userInfo = document.getElementById('userInfo');
                const userEmail = document.getElementById('userEmail');
                if (userInfo && userEmail) {
                    userEmail.textContent = userData.user.email;
                    userInfo.style.display = 'inline';
                }
                
            } catch (error) {
                console.error('Authentication check failed:', error);
                window.location.href = '/';
            }
        }
        
        async function getAuthHeaders() {
            // Get authentication token from localStorage
            const token = localStorage.getItem('access_token');
            if (!token) {
                // Redirect to home page if no token
                window.location.href = '/';
                return {};
            }
            
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }
        
        // Helper function to handle API responses with proper error handling
        async function handleApiResponse(response, errorMessage = 'Request failed') {
            if (response.status === 403) {
                // Admin access denied
                const errorMsg = 'You do not have admin access to this system.';
                localStorage.setItem('auth_error', errorMsg);
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                window.location.href = '/';
                throw new Error(errorMsg);
            } else if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || errorMessage);
            }
            return response;
        }
        
        async function logout() {
            try {
                const headers = await getAuthHeaders();
                await fetch('/auth/signout', {
                    method: 'POST',
                    headers: headers
                });
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                // Clear local storage and redirect to home page
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                window.location.href = '/';
            }
        }
        
        async function handleAction(event) {
            const button = event.target;
            const action = button.dataset.action;
            const volunteerId = button.dataset.volunteerId;
            const email = button.dataset.email;
            
            switch(action) {
                case 'send-confirmation':
                    await sendConfirmation(volunteerId, email);
                    break;
                case 'reset-confirmation':
                    await resetConfirmation(volunteerId, email);
                    break;
                case 'resend-confirmation':
                    await resendConfirmation(volunteerId, email);
                    break;
                case 'deactivate':
                    await deactivateVolunteer(volunteerId, email);
                    break;
                case 'reactivate':
                    await reactivateVolunteer(volunteerId, email);
                    break;
                case 'send-weekly-reminder':
                    await sendWeeklyReminder(volunteerId, email);
                    break;
            }
        }
        
        async function sendConfirmation(volunteerId, email) {
            if (!confirm(`Send confirmation email to ${email}?`)) return;
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`/admin/volunteers/${volunteerId}/send-confirmation`, {
                    method: 'POST',
                    headers: headers
                });
                
                await handleApiResponse(response, 'Failed to send confirmation email');
                const result = await response.json();
                
                alert(`Success: ${result.message}`);
                location.reload(); // Refresh to show updated status
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function resetConfirmation(volunteerId, email) {
            if (!confirm(`Reset confirmation status for ${email}? This will mark them as not having received a confirmation email.`)) return;
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`/admin/volunteers/${volunteerId}/reset-confirmation`, {
                    method: 'POST',
                    headers: headers
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`Success: ${result.message}`);
                    location.reload(); // Refresh to show updated status
                } else {
                    alert(`Error: ${result.detail || 'Failed to reset confirmation status'}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function resendConfirmation(volunteerId, email) {
            if (!confirm(`Resend confirmation email to ${email}?`)) return;
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`/admin/volunteers/${volunteerId}/send-confirmation`, {
                    method: 'POST',
                    headers: headers
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`Success: ${result.message}`);
                    location.reload(); // Refresh to show updated status
                } else {
                    alert(`Error: ${result.detail || 'Failed to resend confirmation email'}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function deactivateVolunteer(volunteerId, email) {
            if (!confirm(`Deactivate volunteer ${email}? This will prevent them from receiving emails and being synced from Google Sheets.`)) return;
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`/admin/volunteers/${volunteerId}/deactivate`, {
                    method: 'POST',
                    headers: headers
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`Success: ${result.message}`);
                    location.reload(); // Refresh to show updated status
                } else {
                    alert(`Error: ${result.detail || 'Failed to deactivate volunteer'}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function reactivateVolunteer(volunteerId, email) {
            if (!confirm(`Reactivate volunteer ${email}? This will allow them to receive emails and be synced from Google Sheets again.`)) return;
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`/admin/volunteers/${volunteerId}/reactivate`, {
                    method: 'POST',
                    headers: headers
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`Success: ${result.message}`);
                    location.reload(); // Refresh to show updated status
                } else {
                    alert(`Error: ${result.detail || 'Failed to reactivate volunteer'}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function sendWeeklyReminder(volunteerId, email) {
            if (!confirm(`Send weekly reminder email to ${email}?`)) return;

            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`/admin/volunteers/${volunteerId}/send-weekly-reminder`, {
                    method: 'POST',
                    headers: headers
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`Success: ${result.message}`);
                    location.reload(); // Refresh to show updated status
                } else {
                    alert(`Error: ${result.detail || 'Failed to send weekly reminder email'}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Global action handler
        async function handleGlobalAction(event) {
            const button = event.target;
            const action = button.dataset.action;
            
            switch(action) {
                case 'send-all-weekly-reminders':
                    await sendAllWeeklyReminders();
                    break;
                case 'get-announcement-recipients':
                    await getAnnouncementRecipients();
                    break;
                case 'sync-volunteers':
                    await syncVolunteers();
                    break;
            }
        }

        async function sendAllWeeklyReminders() {
            if (!confirm('Send weekly reminders to ALL subscribed volunteers? This will send emails to all active volunteers who are subscribed to weekly reminders.')) return;
            
            const button = document.querySelector('[data-action="send-all-weekly-reminders"]');
            const originalText = button.innerHTML;
            
            try {
                // Show loading state
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                button.disabled = true;
                
                const headers = await getAuthHeaders();
                const response = await fetch('/admin/send-weekly-reminders', {
                    method: 'POST',
                    headers: headers
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    let message = `Success: ${result.message}\n\nStatus: ${result.status}`;
                    if (result.emails_sent !== undefined) {
                        message += `\nEmails sent: ${result.emails_sent}`;
                    }
                    if (result.volunteers_processed !== undefined) {
                        message += `\nVolunteers processed: ${result.volunteers_processed}`;
                    }
                    if (result.emails_failed !== undefined && result.emails_failed > 0) {
                        message += `\nEmails failed: ${result.emails_failed}`;
                    }
                    if (result.failed_emails && result.failed_emails.length > 0) {
                        message += `\nFailed emails: ${result.failed_emails.join(', ')}`;
                    }
                    alert(message);
                    location.reload(); // Refresh to show updated status
                } else {
                    alert(`Error: ${result.detail || 'Failed to send weekly reminders'}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function getAnnouncementRecipients() {
            const button = document.querySelector('[data-action="get-announcement-recipients"]');
            const originalText = button.innerHTML;
            
            try {
                // Show loading state
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                button.disabled = true;
                
                const headers = await getAuthHeaders();
                const response = await fetch('/admin/volunteers/announcement-recipients', {
                    method: 'GET',
                    headers: headers
                });
                
                // Check if response is ok before trying to parse JSON
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                
                // Debug logging
                console.log('API Response:', result);
                
                // Validate the response structure
                if (!result || typeof result !== 'object') {
                    throw new Error('Invalid response format from server');
                }
                
                // Create email list once for use throughout the function
                const emailList = result.recipients && Array.isArray(result.recipients) 
                    ? result.recipients.map(v => v.email).filter(email => email).join(', ')
                    : '';
                
                if (response.ok) {
                    // Create a formatted list of recipients
                    let message = `üì¢ Announcement Recipients\n\n`;
                    message += `Total volunteers subscribed to announcements: ${result.total_recipients || 0}\n\n`;
                    
                    if (result.recipients && Array.isArray(result.recipients) && result.recipients.length > 0) {
                        message += `Recipients:\n`;
                        result.recipients.forEach((volunteer, index) => {
                            message += `${index + 1}. ${volunteer.name || 'Unknown'} (${volunteer.email || 'No email'})\n`;
                        });
                        
                        // Add copy-to-clipboard functionality
                        message += `\nüìã Email list (copy this for your email client):\n${emailList}`;
                    } else {
                        message += `No volunteers are currently subscribed to announcements.`;
                    }
                    
                    // Show in a larger dialog or copy to clipboard
                    if (result.recipients && Array.isArray(result.recipients) && result.recipients.length > 0) {
                        // Create a modal-like display
                        const modal = document.createElement('div');
                        modal.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0,0,0,0.5);
                            z-index: 9999;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        `;
                        
                        const content = document.createElement('div');
                        content.style.cssText = `
                            background: white;
                            padding: 20px;
                            border-radius: 8px;
                            max-width: 600px;
                            max-height: 80vh;
                            overflow-y: auto;
                            position: relative;
                        `;
                        
                        content.innerHTML = `
                            <h4>üì¢ Announcement Recipients</h4>
                            <p><strong>Total:</strong> ${result.total_recipients || 0} volunteers</p>
                            <div style="margin: 15px 0;">
                                <button onclick="copyToClipboard('${emailList.replace(/'/g, "\\'")}')" class="btn btn-primary btn-sm">
                                    üìã Copy Email List
                                </button>
                                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary btn-sm ms-2">
                                    Close
                                </button>
                            </div>
                            <div style="margin: 15px 0;">
                                <h6>üìß Email List (Gmail Ready):</h6>
                                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; font-family: monospace; word-break: break-all;">
                                    ${emailList}
                                </div>
                            </div>
                            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #f9f9f9;">
                                <h6>üë• Volunteer Details:</h6>
                                <pre style="margin: 0; white-space: pre-wrap;">${result.recipients.map((v, i) => `${i + 1}. ${v.name || 'Unknown'} (${v.email || 'No email'})`).join('\n')}</pre>
                            </div>
                        `;
                        
                        modal.appendChild(content);
                        modal.className = 'modal-overlay';
                        document.body.appendChild(modal);
                        
                        // Close modal when clicking outside
                        modal.addEventListener('click', (e) => {
                            if (e.target === modal) modal.remove();
                        });
                    } else {
                        alert(message);
                    }
                } else {
                    alert(`Error: ${result.detail || result.message || 'Failed to get announcement recipients'}`);
                }
            } catch (error) {
                console.error('Error in getAnnouncementRecipients:', error);
                alert(`Error: ${error.message || 'Failed to get announcement recipients'}`);
            } finally {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Helper function to copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Email list copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Email list copied to clipboard!');
            });
        }

        async function syncVolunteers() {
            if (!confirm('Sync volunteers from Google Sheets? This will update the volunteer database with the latest information from the signup sheet. This will also send confirmation emails to new volunteers.')) return;
            
            const button = document.querySelector('[data-action="sync-volunteers"]');
            const originalText = button.innerHTML;
            
            try {
                // Show loading state
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
                button.disabled = true;
                
                const headers = await getAuthHeaders();
                const response = await fetch('/admin/sync-volunteers', {
                    method: 'POST',
                    headers: headers
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    let message = `Success: ${result.message}\n\nStatus: ${result.status}`;
                    if (result.details) {
                        message += `\n\nDetails: ${JSON.stringify(result.details, null, 2)}`;
                    }
                    alert(message);
                    location.reload(); // Refresh to show updated data
                } else {
                    alert(`Error: ${result.detail || 'Failed to sync volunteers'}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Admin Management Functions
        async function loadAdminData() {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/admin/users/all', {
                    method: 'GET',
                    headers: headers
                });
                
                await handleApiResponse(response, 'Failed to load admin data');
                
                const data = await response.json();
                
                // Update current user info
                if (data.current_user) {
                    document.getElementById('currentUserEmail').textContent = data.current_user.email;
                    document.getElementById('currentUserRole').textContent = data.current_user.role;
                }
                
                // Update admin count
                document.getElementById('adminCount').textContent = `${data.admins.length} admins`;
                
                // Update admin table
                const tbody = document.getElementById('admins-table-body');
                if (data.admins.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No admins found</td></tr>';
                } else {
                    tbody.innerHTML = data.admins.map(admin => `
                        <tr>
                            <td>${admin.email}</td>
                            <td>
                                <span class="badge ${admin.role === 'super_admin' ? 'bg-danger' : 'bg-primary'}">
                                    ${admin.role === 'super_admin' ? 'Super Admin' : 'Admin'}
                                </span>
                            </td>
                            <td>
                                ${
                                    admin.status === 'active'
                                        ? '<span class="status-badge status-sent">Active</span>'
                                        : '<span class="status-badge status-failed bg-secondary">Inactive</span>'
                                }
                            </td>
                            <td>${admin.last_login || 'Never'}</td>
                            <td>${admin.created_at || 'Unknown'}</td>
                            <td>
                                ${admin.email !== data.current_user.email ? `
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-warning admin-action-btn" 
                                                data-action="change-role" 
                                                data-email="${admin.email}" 
                                                data-current-role="${admin.role}">
                                            Change Role
                                        </button>
                                        <button class="btn btn-sm btn-danger admin-action-btn" 
                                                data-action="remove-admin" 
                                                data-email="${admin.email}">
                                            Remove
                                        </button>
                                    </div>
                                ` : '<span class="text-muted">Current user</span>'}
                            </td>
                        </tr>
                    `).join('');
                    
                    // Add event listeners to admin action buttons
                    document.querySelectorAll('.admin-action-btn').forEach(button => {
                        button.addEventListener('click', handleAdminAction);
                    });
                }
                
            } catch (error) {
                console.error('Error loading admin data:', error);
                document.getElementById('admins-table-body').innerHTML = 
                    '<tr><td colspan="6" class="text-center text-danger">Error loading admin data</td></tr>';
            }
        }
        
        async function handleAddAdmin(event) {
            event.preventDefault();
            
            const email = document.getElementById('newAdminEmail').value.trim();
            const role = document.getElementById('newAdminRole').value;
            
            if (!email) {
                alert('Please enter an email address');
                return;
            }
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/admin/users', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ email: email, role: role })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`Success: ${result.message}`);
                    document.getElementById('add-admin-form').reset();
                    await loadAdminData(); // Refresh the admin list
                } else {
                    alert(`Error: ${result.detail || 'Failed to add admin'}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function handleAdminAction(event) {
            const button = event.target;
            const action = button.dataset.action;
            const email = button.dataset.email;
            
            switch(action) {
                case 'change-role':
                    await changeAdminRole(email, button.dataset.currentRole);
                    break;
                case 'remove-admin':
                    await removeAdmin(email);
                    break;
            }
        }
        
        async function changeAdminRole(email, currentRole) {
            const newRole = currentRole === 'admin' ? 'super_admin' : 'admin';
            const roleName = newRole === 'super_admin' ? 'Super Admin' : 'Admin';
            
            if (!confirm(`Change ${email} role to ${roleName}?`)) return;
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`/admin/users/${encodeURIComponent(email)}/role`, {
                    method: 'PUT',
                    headers: headers,
                    body: JSON.stringify({ role: newRole })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`Success: ${result.message}`);
                    await loadAdminData(); // Refresh the admin list
                } else {
                    alert(`Error: ${result.detail || 'Failed to change role'}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function removeAdmin(email) {
            if (!confirm(`Remove ${email} as admin? This action cannot be undone.`)) return;
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`/admin/users/${encodeURIComponent(email)}`, {
                    method: 'DELETE',
                    headers: headers
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`Success: ${result.message}`);
                    await loadAdminData(); // Refresh the admin list
                } else {
                    alert(`Error: ${result.detail || 'Failed to remove admin'}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Settings form handling
        document.getElementById('settings-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const data = {};
            
            // Collect form data
            for (const el of form.elements) {
                if (el.name && el.type !== 'submit') {
                    data[el.name] = el.value;
                }
            }
            
            // Show loading state
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Saving...';
            submitBtn.disabled = true;
            
            try {
                let success = true;
                let errors = [];
                
                // Update each setting individually
                for (const [key, value] of Object.entries(data)) {
                    try {
                        const response = await fetch(`/settings/${key}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ value: value })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            errors.push(`${key}: ${errorData.detail || 'Failed to update'}`);
                            success = false;
                        }
                    } catch (error) {
                        errors.push(`${key}: ${error.message}`);
                        success = false;
                    }
                }
                
                if (success) {
                    alert('Settings updated successfully!');
                    location.reload();
                } else {
                    alert('Failed to update some settings:\n' + errors.join('\n'));
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                // Restore button state
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // Validate Google Sheets URLs
        function validateGoogleSheetsUrl(url) {
            if (!url) return { isValid: false, message: 'URL is required' };
            
            const pattern = /^https:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
            const match = url.match(pattern);
            
            if (match) {
                return { isValid: true, message: 'Valid Google Sheets URL', sheetId: match[1] };
            } else {
                return { isValid: false, message: 'Please enter a valid Google Sheets URL' };
            }
        }

        // Add validation to Google Sheets URL fields
        document.addEventListener('DOMContentLoaded', function() {
            const sheetFields = ['SCHEDULE_SIGNUP_LINK', 'NEW_SIGNUPS_RESPONSES_LINK'];
            
            sheetFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('blur', function() {
                        const validation = validateGoogleSheetsUrl(this.value);
                        
                        // Remove existing validation classes
                        this.classList.remove('is-valid', 'is-invalid');
                        
                        if (this.value) { // Only validate if there's a value
                            if (validation.isValid) {
                                this.classList.add('is-valid');
                                // Show helpful tooltip
                                this.title = `Valid URL! Sheet ID: ${validation.sheetId}`;
                            } else {
                                this.classList.add('is-invalid');
                                this.title = validation.message;
                            }
                        }
                    });
                }
            });
        });

        // Reset to defaults function
        function resetToDefaults() {
            if (!confirm('Are you sure you want to reset all settings to their default values? This will overwrite all current settings.')) {
                return;
            }
            
            const defaults = {
                'DRY_RUN': 'false',
                'DRY_RUN_EMAIL_RECIPIENT': '',
                'WEEKLY_REMINDERS_ENABLED': 'true',
                'INVITE_LINK_FACEBOOK_MESSENGER': '',
                'INVITE_LINK_DISCORD': '',
                'ONBOARDING_GUIDE_LINK': '',
                'INSTAGRAM_LINK': '',
                'FACEBOOK_PAGE_LINK': '',
                'SCHEDULE_SIGNUP_LINK': 'https://docs.google.com/spreadsheets/d/YOUR_SCHEDULE_SIGNUP_LINK/edit',
                'NEW_SIGNUPS_RESPONSES_LINK': 'https://docs.google.com/spreadsheets/d/YOUR_SIGNUPS_SHEET_ID/edit',
                'SCHEDULE_SHEETS_DISPLAY_WEEKS_COUNT': '4'
            };
            
            // Set form values to defaults
            for (const [key, value] of Object.entries(defaults)) {
                const element = document.getElementById(key);
                if (element) {
                    element.value = value;
                }
            }
            
            alert('Settings have been reset to defaults. Click "Save All Settings" to apply the changes.');
        }

        // Schedule Management Functions
        async function loadScheduleData() {
            try {
                await loadScheduleStatus();
                await loadScheduleStats();
            } catch (error) {
                console.error('Error loading schedule data:', error);
            }
        }

        async function loadScheduleStatus() {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/admin/schedule-status', {
                    method: 'GET',
                    headers: headers
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    const details = data.details;
                    const content = document.getElementById('schedule-status-content');
                    
                    content.innerHTML = `
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-primary">${details.total_sheets}</h4>
                                    <small class="text-muted">Total Sheets</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-success">${details.visible_sheets}</h4>
                                    <small class="text-muted">Visible Sheets</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-warning">${details.hidden_sheets}</h4>
                                    <small class="text-muted">Hidden Sheets</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-info">${details.display_weeks_count}</h4>
                                    <small class="text-muted">Display Weeks</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h6>Sheet Details:</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Sheet Name</th>
                                            <th>Date</th>
                                            <th>Status</th>
                                            <th>Position</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${details.sheets.map(sheet => `
                                            <tr>
                                                <td>${sheet.title}</td>
                                                <td>${sheet.date ? new Date(sheet.date).toLocaleDateString() : 'N/A'}</td>
                                                <td>
                                                    <span class="badge ${sheet.hidden ? 'bg-secondary' : 'bg-success'}">
                                                        ${sheet.hidden ? 'Hidden' : 'Visible'}
                                                    </span>
                                                </td>
                                                <td>${sheet.index}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(data.detail || 'Failed to load schedule status');
                }
            } catch (error) {
                console.error('Error loading schedule status:', error);
                document.getElementById('schedule-status-content').innerHTML = 
                    `<div class="alert alert-danger">Error loading schedule status: ${error.message}</div>`;
            }
        }

        async function loadScheduleStats() {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/admin/schedule-status', {
                    method: 'GET',
                    headers: headers
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    const details = data.details;
                    const stats = document.getElementById('schedule-stats');
                    
                    // Calculate additional statistics
                    const visibleSheets = details.sheets.filter(s => !s.hidden);
                    const hiddenSheets = details.sheets.filter(s => s.hidden);
                    const scheduleSheets = details.sheets.filter(s => s.title.startsWith('Schedule ') && s.title !== 'Schedule Template');
                    
                    stats.innerHTML = `
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Total Sheets:</small><br>
                                <strong>${details.total_sheets}</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Schedule Sheets:</small><br>
                                <strong>${scheduleSheets.length}</strong>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Visible:</small><br>
                                <strong class="text-success">${details.visible_sheets}</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Hidden:</small><br>
                                <strong class="text-warning">${details.hidden_sheets}</strong>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-12">
                                <small class="text-muted">Display Weeks Setting:</small><br>
                                <strong class="text-info">${details.display_weeks_count} weeks</strong>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-12">
                                <small class="text-muted">Last Updated:</small><br>
                                <strong>${new Date().toLocaleString()}</strong>
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(data.detail || 'Failed to load schedule statistics');
                }
            } catch (error) {
                console.error('Error loading schedule statistics:', error);
                document.getElementById('schedule-stats').innerHTML = 
                    `<div class="alert alert-danger">Error loading statistics: ${error.message}</div>`;
            }
        }

        async function rotateSchedule() {
            const displayWeeks = document.getElementById('displayWeeks').value;
            const weeksText = displayWeeks ? `${displayWeeks} weeks` : 'default setting';
            
            if (!confirm(`Are you sure you want to rotate the schedule? This will:\n\n` +
                       `‚Ä¢ Hide old schedule sheets\n` +
                       `‚Ä¢ Show new schedule sheets for ${weeksText}\n` +
                       `‚Ä¢ Reorder sheets as needed\n\n` +
                       `This action cannot be undone.`)) {
                return;
            }
            
            const button = document.querySelector('button[onclick="rotateSchedule()"]');
            const originalText = button.innerHTML;
            
            try {
                // Show loading state
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Rotating...';
                button.disabled = true;
                
                const headers = await getAuthHeaders();
                const url = displayWeeks ? 
                    `/admin/rotate-schedule?display_weeks=${displayWeeks}` : 
                    '/admin/rotate-schedule';
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    let message = `‚úÖ Schedule rotated successfully!\n\n`;
                    message += `Status: ${result.status}\n`;
                    message += `Message: ${result.message}\n\n`;
                    
                    if (result.details) {
                        const details = result.details;
                        message += `üìä Rotation Details:\n`;
                        message += `‚Ä¢ Display weeks: ${details.display_weeks_count}\n`;
                        message += `‚Ä¢ Override used: ${details.display_weeks_override_used ? 'Yes' : 'No'}\n`;
                        message += `‚Ä¢ Sheets created: ${details.changes.sheets_added.length}\n`;
                        message += `‚Ä¢ Sheets hidden: ${details.changes.sheets_hidden.length}\n`;
                        message += `‚Ä¢ Sheets unhidden: ${details.changes.sheets_unhidden.length}\n`;
                        message += `‚Ä¢ Sheets reordered: ${details.changes.sheets_reordered.length}\n\n`;
                        
                        if (details.display_dates && details.display_dates.length > 0) {
                            message += `üìÖ Display dates: ${details.display_dates.join(', ')}\n\n`;
                        }
                        
                        if (details.current_state) {
                            message += `üëÅÔ∏è Current visible sheets: ${details.current_state.visible_sheets.join(', ')}\n`;
                        }
                    }
                    
                    alert(message);
                    
                    // Refresh the schedule data
                    await loadScheduleData();
                } else {
                    alert(`‚ùå Error: ${result.detail || result.message || 'Failed to rotate schedule'}`);
                }
            } catch (error) {
                console.error('Error rotating schedule:', error);
                alert(`‚ùå Error: ${error.message || 'Failed to rotate schedule'}`);
            } finally {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

                // Bot Management Functions
        async function loadBotData() {
            try {
                // Load initial bot status when tab is shown
                await checkKnowledgeStatus();
                
                // Load saved folder ID from localStorage
                const savedFolderId = localStorage.getItem('vietnam_hearts_sync_folder_id');
                if (savedFolderId) {
                    document.getElementById('syncFolderId').value = savedFolderId;
                }
            } catch (error) {
                console.error('Error loading bot data:', error);
            }
        }

        async function syncDocuments() {
            const folderId = document.getElementById('syncFolderId').value.trim();
            const folderText = folderId ? `from folder "${folderId}"` : 'from root directory';
            
            if (!confirm(`Sync documents ${folderText} to the bot's knowledge base? This will update the bot's ability to understand and respond to new documents.\n\nThis process will:\n1. List all available documents in the selected location\n2. Sync each document individually\n3. Show progress and results`)) return;

            const button = document.querySelector('button[onclick="syncDocuments()"]');
            const originalText = button.innerHTML;

            try {
                // Show loading state
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
                button.disabled = true;

                // Step 1: Get list of available documents
                const headers = await getAuthHeaders();
                const folderId = document.getElementById('syncFolderId').value.trim();
                
                // Show progress bar
                const progressDiv = document.getElementById('syncProgress');
                const progressBar = document.getElementById('syncProgressBar');
                const progressText = document.getElementById('syncProgressText');
                progressDiv.style.display = 'block';
                const folderText = folderId ? `from folder "${folderId}"` : 'from root directory';
                progressText.textContent = `Listing available documents ${folderText}...`;
                progressBar.style.width = '10%';
                
                const listResponse = await fetch(`/admin/bot/documents${folderId ? `?folder_id=${encodeURIComponent(folderId)}` : ''}`, {
                    method: 'GET',
                    headers: headers
                });

                if (!listResponse.ok) {
                    throw new Error(`Failed to list documents: ${listResponse.status}`);
                }

                const listData = await listResponse.json();
                
                if (listData.status !== 'success' || !listData.documents || listData.documents.length === 0) {
                    alert(`No documents found ${folderText} to sync`);
                    progressDiv.style.display = 'none';
                    return;
                }

                const documents = listData.documents;
                let successCount = 0;
                let errorCount = 0;
                let totalChunks = 0;
                let totalEmbeddings = 0;
                const errors = [];

                // Step 2: Sync each document individually
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
                progressText.textContent = `Found ${documents.length} documents ${folderText}. Starting sync...`;
                progressBar.style.width = '20%';
                
                for (let i = 0; i < documents.length; i++) {
                    const doc = documents[i];
                    const progress = Math.round(((i + 1) / documents.length) * 100);
                    const progressPercent = 20 + (progress * 0.7); // 20% to 90%
                    
                    progressBar.style.width = `${progressPercent}%`;
                    progressText.textContent = `Syncing ${i + 1}/${documents.length}: ${doc.name}`;
                    
                    try {
                        const syncResponse = await fetch('/admin/bot/knowledge-sync', {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify({
                                doc_id: doc.id,
                                metadata: { name: doc.name, batch_sync: true }
                            })
                        });

                        const syncResult = await syncResponse.json();

                        if (syncResponse.ok && syncResult.status === 'success') {
                            successCount++;
                            totalChunks += syncResult.chunks || 0;
                            totalEmbeddings += syncResult.embeddings || 0;
                        } else {
                            errorCount++;
                            errors.push(`${doc.name}: ${syncResult.detail || syncResult.message || 'Unknown error'}`);
                        }
                    } catch (error) {
                        errorCount++;
                        errors.push(`${doc.name}: ${error.message}`);
                    }

                    // Small delay to avoid overwhelming the API
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                // Step 3: Show results
                progressBar.style.width = '100%';
                progressText.textContent = 'Sync completed!';
                
                let message = `‚úÖ Batch sync completed!\n\n`;
                message += `Total documents: ${documents.length}\n`;
                message += `Successfully synced: ${successCount}\n`;
                message += `Failed: ${errorCount}\n`;
                message += `Total chunks: ${totalChunks}\n`;
                message += `Total embeddings: ${totalEmbeddings}\n`;
                
                if (errors.length > 0) {
                    message += `\nErrors:\n${errors.slice(0, 5).join('\n')}`;
                    if (errors.length > 5) {
                        message += `\n... and ${errors.length - 5} more errors`;
                    }
                }
                
                alert(message);
                
                // Hide progress bar after a short delay
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 2000);
                
                // Refresh bot data
                await loadBotData();
                
            } catch (error) {
                alert(`‚ùå Error: ${error.message || 'Failed to sync documents'}`);
                // Hide progress bar on error
                document.getElementById('syncProgress').style.display = 'none';
            } finally {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function checkKnowledgeStatus() {
            const button = document.querySelector('button[onclick="checkKnowledgeStatus()"]');
            const originalText = button.innerHTML;

            try {
                // Show loading state
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
                button.disabled = true;

                const headers = await getAuthHeaders();
                const response = await fetch('/admin/bot/knowledge-sync/status', {
                    method: 'GET',
                    headers: headers
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();

                // Create a modal-like display for better viewing
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 9999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    max-width: 800px;
                    max-height: 80vh;
                    overflow-y: auto;
                    position: relative;
                `;
                
                let statusHtml = `
                    <h4>üìö Knowledge Base Status</h4>
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h5 class="text-primary">${data.documents_count || 0}</h5>
                                <small class="text-muted">Documents</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h5 class="text-${data.knowledge_service_available ? 'success' : 'danger'}">${data.knowledge_service_available ? '‚úì' : '‚úó'}</h5>
                                <small class="text-muted">Knowledge Service</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h5 class="text-${data.embeddings_available ? 'success' : 'danger'}">${data.embeddings_available ? '‚úì' : '‚úó'}</h5>
                                <small class="text-muted">Embeddings</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h5 class="text-${data.gemini_available ? 'success' : 'danger'}">${data.gemini_available ? '‚úì' : '‚úó'}</h5>
                                <small class="text-muted">Gemini AI</small>
                            </div>
                        </div>
                    </div>
                `;
                
                if (data.documents && data.documents.length > 0) {
                    statusHtml += `
                        <h6>üìÑ Documents in Knowledge Base:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Document</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    data.documents.forEach(doc => {
                        statusHtml += `
                            <tr>
                                <td>${doc.title || doc.name || 'Unknown'}</td>
                                <td>${doc.type || 'Document'}</td>
                                <td>
                                    <span class="badge bg-success">Active</span>
                                </td>
                            </tr>
                        `;
                    });
                    
                    statusHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    statusHtml += `<p class="text-muted">No documents found in knowledge base.</p>`;
                }
                
                statusHtml += `
                    <div class="mt-3">
                        <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">
                            Close
                        </button>
                    </div>
                `;
                
                content.innerHTML = statusHtml;
                modal.appendChild(content);
                modal.className = 'modal-overlay';
                document.body.appendChild(modal);
                
                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
                
            } catch (error) {
                alert(`‚ùå Error: ${error.message || 'Failed to check knowledge status'}`);
            } finally {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function listAvailableDocuments() {
            const button = document.querySelector('button[onclick="listAvailableDocuments()"]');
            const originalText = button.innerHTML;
            const folderId = document.getElementById('syncFolderId').value.trim();

            try {
                // Show loading state
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Listing...';
                button.disabled = true;

                const headers = await getAuthHeaders();
                const response = await fetch(`/admin/bot/documents${folderId ? `?folder_id=${encodeURIComponent(folderId)}` : ''}`, {
                    method: 'GET',
                    headers: headers
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();

                if (data.status === 'success') {
                    // Create a modal-like display for better viewing
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        z-index: 9999;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
                    
                    const content = document.createElement('div');
                    content.style.cssText = `
                        background: white;
                        padding: 20px;
                        border-radius: 8px;
                        max-width: 900px;
                        max-height: 80vh;
                        overflow-y: auto;
                        position: relative;
                    `;
                    
                    const folderId = document.getElementById('syncFolderId').value.trim();
                    const folderText = folderId ? `in folder "${folderId}"` : 'in root directory';
                    
                    let documentsHtml = `
                        <h4>üìÑ Available Documents</h4>
                        <p><strong>Location:</strong> ${folderText}</p>
                        <p><strong>Total Documents:</strong> ${data.count || 0}</p>
                        <p><strong>Requested by:</strong> ${data.requested_by || 'Unknown'}</p>
                    `;
                    
                    if (data.documents && data.documents.length > 0) {
                        documentsHtml += `
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Document Name</th>
                                            <th>Type</th>
                                            <th>Size</th>
                                            <th>Modified</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        data.documents.forEach(doc => {
                            const modifiedDate = doc.modifiedTime ? new Date(doc.modifiedTime).toLocaleDateString() : 'N/A';
                            const size = doc.size ? `${Math.round(doc.size / 1024)} KB` : 'N/A';
                            
                            documentsHtml += `
                                <tr>
                                    <td>${doc.name || 'Unknown'}</td>
                                    <td>${doc.mimeType || 'Document'}</td>
                                    <td>${size}</td>
                                    <td>${modifiedDate}</td>
                                    <td>
                                        ${doc.webViewLink ? `<a href="${doc.webViewLink}" target="_blank" class="btn btn-sm btn-primary">View</a>` : ''}
                                        ${doc.id ? `<button onclick="syncSingleDocument('${doc.id}', '${doc.name || 'Unknown'}')" class="btn btn-sm btn-success">Sync</button>` : ''}
                                    </td>
                                </tr>
                            `;
                        });
                        
                        documentsHtml += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    } else {
                        documentsHtml += `<p class="text-muted">No documents found.</p>`;
                    }
                    
                    documentsHtml += `
                        <div class="mt-3">
                            <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">
                                Close
                            </button>
                        </div>
                    `;
                    
                    content.innerHTML = documentsHtml;
                    modal.appendChild(content);
                    modal.className = 'modal-overlay';
                    document.body.appendChild(modal);
                    
                    // Close modal when clicking outside
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) modal.remove();
                    });
                    
                } else {
                    alert(`‚ùå Error: ${data.detail || data.message || 'Failed to list documents'}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message || 'Failed to list documents'}`);
            } finally {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Helper function to sync a single document
        async function syncSingleDocument(docId, docName) {
            if (!confirm(`Sync document "${docName}" to the knowledge base?`)) return;
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/admin/bot/knowledge-sync', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        doc_id: docId,
                        metadata: { name: docName }
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`‚úÖ Document "${docName}" synced successfully!\n\nStatus: ${result.status}\nMessage: ${result.message}\nChunks: ${result.chunks || 0}\nEmbeddings: ${result.embeddings || 0}`);
                    // Refresh bot data
                    await loadBotData();
                } else {
                    alert(`‚ùå Error syncing "${docName}": ${result.detail || result.message || 'Failed to sync document'}`);
                }
            } catch (error) {
                alert(`‚ùå Error syncing "${docName}": ${error.message || 'Failed to sync document'}`);
            }
        }

        // Helper function to set test questions
        function setTestQuestion(question) {
            document.getElementById('testQuestion').value = question;
        }

        // Test folder access
        async function testFolderAccess() {
            const folderId = document.getElementById('syncFolderId').value.trim();
            if (!folderId) {
                alert('Please enter a folder ID first');
                return;
            }

            const button = document.querySelector('button[onclick="testFolderAccess()"]');
            const originalText = button.innerHTML;
            const resultDiv = document.getElementById('folderTestResult');

            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
                button.disabled = true;
                resultDiv.style.display = 'none';

                const headers = await getAuthHeaders();
                const response = await fetch(`/admin/bot/documents?folder_id=${encodeURIComponent(folderId)}`, {
                    method: 'GET',
                    headers: headers
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();

                if (data.status === 'success') {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> 
                            <strong>Folder accessible!</strong><br>
                            Found ${data.count} Google Doc(s) in this folder.
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> 
                            <strong>Folder test completed</strong><br>
                            ${data.detail || data.message || 'Unknown response'}
                        </div>
                    `;
                }
                resultDiv.style.display = 'block';

            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle"></i> 
                        <strong>Error testing folder:</strong><br>
                        ${error.message}
                    </div>
                `;
                resultDiv.style.display = 'block';
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Clear folder selection
        function clearFolderSelection() {
            document.getElementById('syncFolderId').value = '';
            document.getElementById('folderTestResult').style.display = 'none';
            localStorage.removeItem('vietnam_hearts_sync_folder_id');
        }

        // Save folder ID to localStorage when it changes
        function saveFolderId() {
            const folderId = document.getElementById('syncFolderId').value.trim();
            if (folderId) {
                localStorage.setItem('vietnam_hearts_sync_folder_id', folderId);
            } else {
                localStorage.removeItem('vietnam_hearts_sync_folder_id');
            }
        }

        // Preview documents in selected folder
        async function listDocumentsInFolder() {
            const folderId = document.getElementById('syncFolderId').value.trim();
            const folderText = folderId ? `in folder "${folderId}"` : 'in root directory';
            
            if (!confirm(`Preview documents ${folderText}? This will show you what documents will be synced.`)) return;

            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`/admin/bot/documents${folderId ? `?folder_id=${encodeURIComponent(folderId)}` : ''}`, {
                    method: 'GET',
                    headers: headers
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();

                if (data.status === 'success') {
                    let message = `üìÑ Documents ${folderText}\n\n`;
                    message += `Total documents found: ${data.count}\n\n`;
                    
                    if (data.documents && data.documents.length > 0) {
                        message += `Documents:\n`;
                        data.documents.forEach((doc, index) => {
                            const modifiedDate = doc.modified_time ? new Date(doc.modified_time).toLocaleDateString() : 'N/A';
                            message += `${index + 1}. ${doc.name}\n`;
                            message += `   - Modified: ${modifiedDate}\n`;
                            message += `   - ID: ${doc.id}\n`;
                        });
                    } else {
                        message += `No documents found in this location.`;
                    }
                    
                    alert(message);
                } else {
                    alert(`‚ùå Error: ${data.detail || data.message || 'Failed to list documents'}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message || 'Failed to preview documents'}`);
            }
        }

        // Test bot functionality
        async function testBot() {
            const question = document.getElementById('testQuestion').value.trim();
            if (!question) {
                alert('Please enter a test question');
                return;
            }

            const button = document.querySelector('button[onclick="testBot()"]');
            const originalText = button.innerHTML;

            try {
                // Show loading state
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
                button.disabled = true;

                // Use the public bot endpoint for testing
                const response = await fetch('/bot/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: question,
                        user_context: { test_mode: true, admin_test: true }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const result = await response.json();

                // Display results
                document.getElementById('botResponse').textContent = result.response || 'No response';
                document.getElementById('botConfidence').textContent = `${(result.confidence * 100).toFixed(1)}%`;
                document.getElementById('botSources').textContent = result.sources ? result.sources.join(', ') : 'None';
                document.getElementById('botContext').textContent = result.context_used || '0';

                // Show results
                document.getElementById('testResult').style.display = 'block';

            } catch (error) {
                alert(`‚ùå Error testing bot: ${error.message || 'Failed to test bot'}`);
            } finally {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Knowledge Base Debug Functions
        async function inspectKnowledgeBaseChunks() {
            const button = document.querySelector('button[onclick="inspectKnowledgeBaseChunks()"]');
            const originalText = button.innerHTML;

            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Inspecting...';
                button.disabled = true;

                const headers = await getAuthHeaders();
                const response = await fetch('/admin/bot/knowledge-base/chunks?limit=20', {
                    method: 'GET',
                    headers: headers
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();

                if (data.status === 'success') {
                    let html = `<h6>üìö Knowledge Base Contents (${data.total_chunks} chunks)</h6>`;
                    
                    if (data.chunks && data.chunks.length > 0) {
                        html += `<div class="table-responsive mt-3">`;
                        html += `<table class="table table-sm">`;
                        html += `<thead><tr><th>Chunk</th><th>Document ID</th><th>Content Preview</th><th>Length</th></tr></thead><tbody>`;
                        
                        data.chunks.forEach((chunk, index) => {
                            html += `<tr>`;
                            html += `<td><strong>${chunk.chunk_index}</strong></td>`;
                            html += `<td><code>${chunk.source_document_id}</code></td>`;
                            html += `<td><small>${chunk.content_preview}</small></td>`;
                            html += `<td>${chunk.content_length} chars</td>`;
                            html += `</tr>`;
                        });
                        
                        html += `</tbody></table></div>`;
                    } else {
                        html += `<p class="text-muted">No chunks found in knowledge base.</p>`;
                    }
                    
                    document.getElementById('debugContent').innerHTML = html;
                    document.getElementById('debugResults').style.display = 'block';
                } else {
                    alert(`‚ùå Error: ${data.detail || data.message || 'Failed to inspect chunks'}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message || 'Failed to inspect chunks'}`);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function testKnowledgeBaseSearch() {
            const question = prompt('Enter a search query to test the knowledge base search:');
            if (!question) return;

            const button = document.querySelector('button[onclick="testKnowledgeBaseSearch()"]');
            const originalText = button.innerHTML;

            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
                button.disabled = true;

                const headers = await getAuthHeaders();
                const response = await fetch('/admin/bot/knowledge-base/test-search', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        message: question,
                        user_context: { debug_mode: true }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();

                if (data.status === 'success') {
                    let html = `<h6>üîç Search Test Results for: "${data.query}"</h6>`;
                    html += `<p><strong>Search Parameters:</strong> Limit: ${data.search_parameters.limit}, Threshold: ${data.search_parameters.threshold}</p>`;
                    html += `<p><strong>Results Found:</strong> ${data.total_results} chunks</p>`;
                    
                    if (data.results && data.results.length > 0) {
                        html += `<div class="table-responsive mt-3">`;
                        html += `<table class="table table-sm">`;
                        html += `<thead><tr><th>Chunk</th><th>Similarity</th><th>Document ID</th><th>Content Preview</th></tr></thead><tbody>`;
                        
                        data.results.forEach((result, index) => {
                            html += `<tr>`;
                            html += `<td><strong>${result.chunk_index}</strong></td>`;
                            html += `<td><span class="badge bg-${result.similarity > 0.7 ? 'success' : result.similarity > 0.5 ? 'warning' : 'danger'}">${(result.similarity * 100).toFixed(1)}%</span></td>`;
                            html += `<td><code>${result.source_document_id}</code></td>`;
                            html += `<td><small>${result.content_preview}</small></td>`;
                            html += `</tr>`;
                        });
                        
                        html += `</tbody></table></div>`;
                    } else {
                        html += `<p class="text-muted">No results found for this query.</p>`;
                    }
                    
                    document.getElementById('debugContent').innerHTML = html;
                    document.getElementById('debugResults').style.display = 'block';
                } else {
                    alert(`‚ùå Error: ${data.detail || data.message || 'Failed to test search'}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message || 'Failed to test search'}`);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        function clearDebugResults() {
            document.getElementById('debugResults').style.display = 'none';
            document.getElementById('debugContent').innerHTML = '';
        }
    </script>
</body>
</html> 